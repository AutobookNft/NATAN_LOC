#!/bin/bash
#
# PRE-COMMIT HOOK - PROTEZIONE CODICE CRITICO
# Previene eliminazione accidentale di codice
# Blocca commit che rimuovono troppe righe senza verifica
#

# Colori per output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "üîí PRE-COMMIT HOOK: Verifica protezione codice..."
echo ""

# Verifica modifiche
STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ Nessun file modificato"
    exit 0
fi

# Flag per errori critici
CRITICAL_ERROR=0
WARNING=0

# Analizza ogni file modificato
for file in $STAGED_FILES; do
    # Skip se file non esiste (deleted)
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # Skip file binari e non-text
    if git diff --cached -- "$file" | grep -q "^Binary files"; then
        continue
    fi
    
    # Calcola statistiche modifiche
    STATS=$(git diff --cached --stat -- "$file" | tail -1)
    
    # Estrai numeri: +inserimenti -rimozioni
    if echo "$STATS" | grep -qE '[0-9]+.*[0-9]+'; then
        ADDED=$(echo "$STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
        DELETED=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
        
        # Rimuovi "+" e "-" se presenti
        ADDED=${ADDED#+}
        DELETED=${DELETED#-}
        
        # Converte a interi
        ADDED=${ADDED:-0}
        DELETED=${DELETED:-0}
        
        # ‚ö†Ô∏è REGOLA 1: Blocca se rimuove pi√π di 100 righe
        if [ "$DELETED" -gt 100 ]; then
            echo -e "${RED}‚ùå ERRORE CRITICO:${NC} File '$file' rimuove ${DELETED} righe!"
            echo -e "   ${YELLOW}‚ö†Ô∏è  Questo potrebbe essere un errore accidentale${NC}"
            echo ""
            echo "   Statistiche:"
            echo "   - Righe aggiunte: ${ADDED}"
            echo "   - Righe rimosse: ${DELETED}"
            echo ""
            echo "   Se √® INTENZIONALE, usa:"
            echo "   ${GREEN}git commit --no-verify${NC}"
            echo "   ${YELLOW}(solo se sei assolutamente sicuro!)${NC}"
            echo ""
            CRITICAL_ERROR=1
        fi
        
        # ‚ö†Ô∏è REGOLA 2: Warning se rimuove pi√π di 50 righe
        if [ "$DELETED" -gt 50 ] && [ "$DELETED" -le 100 ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  WARNING:${NC} File '$file' rimuove ${DELETED} righe"
            echo "   Verifica che sia intenzionale"
            WARNING=1
        fi
        
        # ‚ö†Ô∏è REGOLA 3: Blocca se rimuove pi√π del 50% del file
        if [ -f "$file" ]; then
            TOTAL_LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
            if [ "$TOTAL_LINES" -gt 0 ]; then
                PERCENTAGE=$((DELETED * 100 / TOTAL_LINES))
                if [ "$PERCENTAGE" -gt 50 ]; then
                    echo -e "${RED}‚ùå ERRORE CRITICO:${NC} File '$file' rimuove ${PERCENTAGE}% del contenuto!"
                    echo "   Righe totali: ${TOTAL_LINES}"
                    echo "   Righe rimosse: ${DELETED}"
                    echo ""
                    echo "   Se √® INTENZIONALE, usa:"
                    echo "   ${GREEN}git commit --no-verify${NC}"
                    echo ""
                    CRITICAL_ERROR=1
                fi
            fi
        fi
    fi
done

# ‚ö†Ô∏è REGOLA 4: Blocca se rimuove pi√π di 500 righe totali
TOTAL_DELETED=$(git diff --cached --shortstat | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
TOTAL_DELETED=${TOTAL_DELETED:-0}

if [ "$TOTAL_DELETED" -gt 500 ]; then
    echo -e "${RED}‚ùå ERRORE CRITICO:${NC} Commit rimuove ${TOTAL_DELETED} righe totali!"
    echo "   ${YELLOW}‚ö†Ô∏è  Questo √® un cambiamento MASSICCIO${NC}"
    echo ""
    echo "   Verifica che:"
    echo "   1. Non hai fatto un reset accidentale"
    echo "   2. Non hai sovrascritto file con versioni vecchie"
    echo "   3. Hai verificato ogni file modificato"
    echo ""
    echo "   Se √® INTENZIONALE, usa:"
    echo "   ${GREEN}git commit --no-verify${NC}"
    echo ""
    CRITICAL_ERROR=1
fi

# Mostra riepilogo
echo ""
if [ "$CRITICAL_ERROR" -eq 1 ]; then
    echo -e "${RED}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${RED}‚ùå COMMIT BLOCCATO - ERRORI CRITICI TROVATI${NC}"
    echo -e "${RED}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo "Per sicurezza, il commit √® stato BLOCCATO."
    echo ""
    echo "Azioni consigliate:"
    echo "1. Verifica i file modificati: ${GREEN}git diff --cached${NC}"
    echo "2. Verifica statistiche: ${GREEN}git diff --cached --stat${NC}"
    echo "3. Se √® un errore, ripristina: ${GREEN}git restore --staged <file>${NC}"
    echo "4. Se √® intenzionale, usa: ${GREEN}git commit --no-verify${NC}"
    echo ""
    exit 1
fi

if [ "$WARNING" -eq 1 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNINGS trovati - verifica i file modificati${NC}"
    echo ""
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passati${NC}"
exit 0

