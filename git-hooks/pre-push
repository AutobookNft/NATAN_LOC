#!/bin/bash
#
# PRE-PUSH HOOK - PROTEZIONE ULTERIORE
# Previene push di commit pericolosi
#

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "ğŸ”’ PRE-PUSH HOOK: Verifica protezione codice..."
echo ""

# Verifica se ci sono commit che rimuovono troppe righe
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "origin/main")

if [ -z "$REMOTE_BRANCH" ]; then
    echo "âš ï¸  Branch remoto non trovato, skip check"
    exit 0
fi

# Analizza commit da pushare
COMMITS=$(git rev-list HEAD ^$REMOTE_BRANCH 2>/dev/null || echo "")

if [ -z "$COMMITS" ]; then
    echo "âœ… Nessun commit da pushare"
    exit 0
fi

CRITICAL_ERROR=0

for commit in $COMMITS; do
    # Verifica statistiche commit
    STATS=$(git show --stat --format="" $commit)
    
    TOTAL_DELETED=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' | awk '{sum+=$1} END {print sum+0}')
    TOTAL_DELETED=${TOTAL_DELETED:-0}
    
    if [ "$TOTAL_DELETED" -gt 500 ]; then
        echo -e "${RED}âŒ ERRORE CRITICO:${NC} Commit ${commit:0:8} rimuove ${TOTAL_DELETED} righe!"
        echo "   Messaggio: $(git log -1 --format='%s' $commit)"
        echo ""
        echo "   Verifica che sia intenzionale prima di pushare"
        echo ""
        CRITICAL_ERROR=1
    fi
done

if [ "$CRITICAL_ERROR" -eq 1 ]; then
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}âŒ PUSH BLOCCATO - COMMIT PERICOLOSI TROVATI${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "Per sicurezza, il push Ã¨ stato BLOCCATO."
    echo ""
    echo "Azioni consigliate:"
    echo "1. Verifica commit: ${GREEN}git log --stat${NC}"
    echo "2. Se Ã¨ un errore, ripristina: ${GREEN}git reset HEAD~N${NC}"
    echo "3. Se Ã¨ intenzionale, usa: ${GREEN}git push --no-verify${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ… Pre-push checks passati${NC}"
exit 0

